FROM ubuntu:24.04

# Install build dependencies
RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y \
    git python3 python3-pip scons mingw-w64 curl unzip make gcc g++ \
    && apt-get clean

# Build zlib 1.3.1 for Win32 (DLL + import lib)
WORKDIR /tmp
RUN curl -LO https://zlib.net/zlib-1.3.1.tar.gz && \
    tar xzf zlib-1.3.1.tar.gz && \
    cd zlib-1.3.1 && \
    # Clean just in case
    make distclean || true && \
    # Build DLL with import lib for Win32
    make -f win32/Makefile.gcc \
        PREFIX=i686-w64-mingw32- \
        SHARED_MODE=1 \
        BINARY_PATH=/opt/zlib-win32/bin \
        INCLUDE_PATH=/opt/zlib-win32/include \
        LIBRARY_PATH=/opt/zlib-win32/lib \
        install && \
    # Copy import library to the name NSIS expects
    cp /opt/zlib-win32/lib/libz.dll.a /opt/zlib-win32/lib/zlib1.lib

# Clone NSIS
RUN git clone --branch v311 --depth 1 https://github.com/kichik/nsis.git /opt/nsis

# Patch config.h and build NSIS
WORKDIR /opt/nsis
RUN sed -i 's/^#define NSIS_MAX_STRLEN.*/#define NSIS_MAX_STRLEN 8192/' Source/exehead/config.h && \
    echo "#define NSIS_CONFIG_LOG" >> Source/exehead/config.h && \
    echo "#define NSIS_SUPPORT_LOG" >> Source/exehead/config.h && \
    CC=i686-w64-mingw32-gcc \
    CXX=i686-w64-mingw32-g++ \
    CFLAGS="-I/opt/zlib-win32/include" \
    LDFLAGS="-L/opt/zlib-win32/lib" \
    ZLIB_W32=/opt/zlib-win32 \
    scons STRIP=0 \
        NSIS_MAX_STRLEN=8192 \
        NSIS_CONFIG_LOG=yes \
        NSIS_CONFIG_CONST_DATA_PATH=no \
        SKIPSTUBS=all \
        SKIPPLUGINS=all

# Show result
CMD ["find", "Build", "-iname", "makensis.exe"]
