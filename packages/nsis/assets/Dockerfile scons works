FROM ubuntu:24.04

########################################
# Install dependencies
########################################
RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y \
    git python3 python3-pip scons mingw-w64 curl unzip make gcc g++ \
    && apt-get clean

WORKDIR /tmp
########################################
# Build zlib 1.3.1 (32-bit + 64-bit, static + DLL)
########################################
WORKDIR /tmp
RUN curl -sL https://zlib.net/zlib-1.3.1.tar.gz | tar xz

# --- Win32 ---
# Build zlib Win32 (32-bit)
WORKDIR /tmp/zlib-1.3.1
RUN make distclean || true && \
    make -f win32/Makefile.gcc \
        PREFIX=i686-w64-mingw32- \
        SHARED_MODE=1 \
        BINARY_PATH=/opt/zlib-w32/bin \
        INCLUDE_PATH=/opt/zlib-w32/include \
        LIBRARY_PATH=/opt/zlib-w32/lib \
        install && \
    # Copy import library to the name NSIS expects
    cp /opt/zlib-w32/lib/libz.dll.a /opt/zlib-w32/lib/zlib1.lib


# --- Win64 ---
RUN make distclean || true && \
    make -f win32/Makefile.gcc \
      PREFIX=x86_64-w64-mingw32- \
      SHARED_MODE=1 \
      BINARY_PATH=/opt/zlib-w64/bin \
      INCLUDE_PATH=/opt/zlib-w64/include \
      LIBRARY_PATH=/opt/zlib-w64/lib \
      install


########################################
# Clone NSIS
########################################
WORKDIR /opt
RUN git clone https://github.com/kichik/nsis.git nsis-src
WORKDIR /opt/nsis-src

########################################
# Common ENV
########################################
ENV ZLIB_W32=/opt/zlib-w32
ENV ZLIB_W64=/opt/zlib-w64

########################################
# Build NSIS 32-bit
########################################
RUN ZLIB_W32=/opt/zlib-w32 \
    CC=i686-w64-mingw32-gcc \
    CXX=i686-w64-mingw32-g++ \
    CFLAGS="-I/opt/zlib-w32/include" \
    LDFLAGS="-L/opt/zlib-w32/lib" \
    scons -c
    
RUN ZLIB_W32=/opt/zlib-w32 \
    CC=i686-w64-mingw32-gcc \
    CXX=i686-w64-mingw32-g++ \
    CFLAGS="-I/opt/zlib-w32/include" \
    LDFLAGS="-L/opt/zlib-w32/lib" \
    scons STRIP=0 \
      NSIS_MAX_STRLEN=8192 \
      NSIS_CONFIG_LOG=yes \
      NSIS_CONFIG_CONST_DATA_PATH=no \
      SKIPSTUBS=all \
      SKIPPLUGINS=all \
      BUILD_TARGET=Win32 && \
    mkdir -p /opt/nsis-builds/win32 && \
    cp build/urelease/makensis.exe /opt/nsis-builds/win32/


########################################
# Build NSIS Win64
########################################
RUN scons -c && \
    CC=x86_64-w64-mingw32-gcc \
    CXX=x86_64-w64-mingw32-g++ \
    CFLAGS="-I${ZLIB_W64}/include" \
    LDFLAGS="-L${ZLIB_W64}/lib" \
    scons STRIP=0 \
      NSIS_MAX_STRLEN=8192 \
      NSIS_CONFIG_LOG=yes \
      NSIS_CONFIG_CONST_DATA_PATH=no \
      SKIPSTUBS=all \
      SKIPPLUGINS=all \
      BUILD_TARGET=amd64 && \
    mkdir -p /opt/nsis-builds/win64 && \
    cp build/urelease/makensis.exe /opt/nsis-builds/win64/

########################################
# Output
########################################
WORKDIR /opt/nsis-builds