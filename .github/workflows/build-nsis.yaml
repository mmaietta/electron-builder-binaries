name: Build NSIS

on:
  workflow_call:
  workflow_dispatch:

jobs:
  # Build base bundle (Windows binary + plugins + data)
  base:
    name: Build Base Bundle
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl unzip p7zip-full
        shell: bash

      - name: Build base bundle
        run: bash ./build.sh windows
        shell: bash
        working-directory: ./packages/nsis

      - name: Upload base artifact
        uses: actions/upload-artifact@v4
        with:
          name: nsis-temp-base
          path: packages/nsis/out/**/*.tar.gz
          if-no-files-found: error
          retention-days: 1

  # Build native macOS binaries
  mac:
    name: Build macOS Binary (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-15-intel
            arch: x64
          - runner: macos-15
            arch: arm64
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install scons
        shell: bash

      - name: Build macOS binary
        run: bash ./build.sh mac
        shell: bash
        working-directory: ./packages/nsis

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: nsis-temp-macos-${{ matrix.arch }}
          path: packages/nsis/out/**/*.tar.gz
          if-no-files-found: error
          retention-days: 1

  # Build native Linux binary using Docker
  linux:
    name: Build Linux Binary
    runs-on: ubuntu-latest
    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Linux binary
        run: bash ./build.sh linux
        shell: bash
        working-directory: ./packages/nsis

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: nsis-temp-linux
          path: packages/nsis/out/**/*.tar.gz
          if-no-files-found: error
          retention-days: 1

  # Combine all artifacts into final bundle
  combine-artifacts:
    name: Combine All Bundles
    runs-on: macos-latest
    needs: [base, mac, linux]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all NSIS artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: nsis-temp-*
          path: packages/nsis/out
          merge-multiple: true

      - name: List downloaded artifacts
        run: |
          echo "Downloaded artifacts:"
          ls -lhR packages/nsis/out
        shell: bash

      - name: Combine bundles
        run: bash ./assets/nsis-combine.sh
        shell: bash
        working-directory: ./packages/nsis

      - name: Delete intermediate artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: nsis-temp-*

      - name: Upload combined bundle
        uses: actions/upload-artifact@v4
        with:
          name: nsis-bundle
          path: packages/nsis/out/**/*.tar.gz
          if-no-files-found: error
          retention-days: 30

  test-nsis:
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - platform: Windows
            runner: windows-latest
            binary: makensis.ps1
          - platform: Windows
            runner: windows-latest
            binary: makensis.cmd
          - platform: Linux
            runner: ubuntu-latest
            binary: makensis
          - platform: macOS-x64
            runner: macos-15-intel
            binary: makensis
          - platform: macOS-arm64
            runner: macos-15
            binary: makensis
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up environment
        run: |
          echo "Platform: ${{ matrix.platform }}"
          echo "Runner: ${{ matrix.runner }}"

      - name: Find NSIS bundle
        run: |
          BUNDLE_PATH="./nsis"
          NSIS_BUNDLE="$BUNDLE_PATH/nsis-bundle"
          cd $BUNDLE_PATH
          
          shopt -s nullglob || true  # Enable nullglob on Unix shells
          archives=( *complete*.tar.gz )
          
          if [[ ${#archives[@]} -eq 0 ]]; then
              echo "ERROR: no *complete*.tar.gz files found"
              exit 1
          fi
          
          echo "Using archive: ${archives[0]}"
          tar -xzf "${archives[0]}"
          echo "NSIS bundle extracted to $NSIS_BUNDLE"

      # Step: Test makensis binary (PowerShell on Windows)
      - name: Test makensis (PowerShell)
        if: runner.os == 'Windows' && endsWith(matrix.binary, '.ps1')
        shell: pwsh
        run: |
          BINARY_PATH="$NSIS_BUNDLE/${{ matrix.binary }}"
          echo "Running PowerShell binary: $BINARY_PATH"
          & "$BINARY_PATH" -VERSION

      # Step: Test makensis binary (CMD on Windows)
      - name: Test makensis (CMD)
        if: runner.os == 'Windows' && endsWith(matrix.binary, '.cmd')
        shell: cmd
        run: |
          BINARY_PATH="%NSIS_BUNDLE%\${{ matrix.binary }}"
          echo Running CMD binary: %BINARY_PATH%
          "%BINARY_PATH%" -VERSION

      # Step: Test makensis binary (Linux/macOS)
      - name: Test makensis (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          BINARY_PATH="$NSIS_BUNDLE/${{ matrix.binary }}"
          chmod +x "$BINARY_PATH"
          "$BINARY_PATH" -VERSION

      - name: Create test NSIS script
        run: |
          cat > test.nsi << 'EOF'
          !include "MUI2.nsh"

          Name "Test Installer"
          OutFile "test-installer.exe"
          InstallDir "$PROGRAMFILES\TestApp"

          !insertmacro MUI_PAGE_WELCOME
          !insertmacro MUI_PAGE_DIRECTORY
          !insertmacro MUI_PAGE_INSTFILES
          !insertmacro MUI_PAGE_FINISH

          !insertmacro MUI_LANGUAGE "English"

          Section "Main"
            SetOutPath "$INSTDIR"
            WriteUninstaller "$INSTDIR\Uninstall.exe"
          SectionEnd

          Section "Uninstall"
            Delete "$INSTDIR\Uninstall.exe"
            RMDir "$INSTDIR"
          SectionEnd
          EOF

      # Step: Compile installer (PowerShell)
      - name: Compile test installer (PowerShell)
        if: runner.os == 'Windows' && endsWith(matrix.binary, '.ps1')
        shell: pwsh
        run: |
          BINARY_PATH="$NSIS_BUNDLE/${{ matrix.binary }}"
          & "$BINARY_PATH" test.nsi

      # Step: Compile installer (CMD)
      - name: Compile test installer (CMD)
        if: runner.os == 'Windows' && endsWith(matrix.binary, '.cmd')
        shell: cmd
        run: |
          BINARY_PATH="%NSIS_BUNDLE%\${{ matrix.binary }}"
          "%BINARY_PATH%" test.nsi

      # Step: Compile installer (Linux/macOS)
      - name: Compile test installer (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          BINARY_PATH="$NSIS_BUNDLE/${{ matrix.binary }}"
          chmod +x "$BINARY_PATH"
          "$BINARY_PATH" test.nsi

      - name: Verify output
        run: |
          ls -l
          if [[ -f test-installer.exe ]]; then
              echo "✅ Test compilation successful!"
          else
              echo "❌ Test compilation failed – no output file"
              exit 1
          fi

      - name: Check NSIS plugins
        run: |
          plugin_count="$(find share/nsis/Plugins -name "*.dll" 2>/dev/null | wc -l | tr -d ' ')"
          echo "Found $plugin_count plugin DLLs"
          if (( plugin_count < 20 )); then
              echo "⚠️  Warning: Expected more plugins"
          else
              echo "✅ Plugin count looks good"
          fi