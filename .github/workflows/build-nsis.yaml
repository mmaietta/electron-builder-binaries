name: Build NSIS

on:
  workflow_call:
  workflow_dispatch:

jobs:
  # Build base bundle (Windows binary + plugins + data)
  base:
    name: Build Base Bundle
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl unzip p7zip-full
        shell: bash

      - name: Build base bundle
        run: bash ./build.sh windows
        shell: bash
        working-directory: ./packages/nsis

      - name: Upload base artifact
        uses: actions/upload-artifact@v4
        with:
          name: nsis-temp-base
          path: packages/nsis/out/**/*.tar.gz
          if-no-files-found: error
          retention-days: 1

  # Build native macOS binaries
  mac:
    name: Build macOS Binary (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-15-intel
            arch: x64
          - runner: macos-15
            arch: arm64
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install scons
        shell: bash

      - name: Build macOS binary
        run: bash ./build.sh mac
        shell: bash
        working-directory: ./packages/nsis

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: nsis-temp-macos-${{ matrix.arch }}
          path: packages/nsis/out/**/*.tar.gz
          if-no-files-found: error
          retention-days: 1

  # Build native Linux binary using Docker
  linux:
    name: Build Linux Binary
    runs-on: ubuntu-latest
    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Linux binary
        run: bash ./build.sh linux
        shell: bash
        working-directory: ./packages/nsis

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: nsis-temp-linux
          path: packages/nsis/out/**/*.tar.gz
          if-no-files-found: error
          retention-days: 1

  # Combine all artifacts into final bundle
  combine-artifacts:
    name: Combine All Bundles
    runs-on: macos-latest
    needs: [base, mac, linux]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all NSIS artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: nsis-temp-*
          path: packages/nsis/out
          merge-multiple: true

      - name: List downloaded artifacts
        run: |
          echo "Downloaded artifacts:"
          ls -lhR packages/nsis/out
        shell: bash

      - name: Combine bundles
        run: bash ./assets/nsis-combine.sh
        shell: bash
        working-directory: ./packages/nsis

      - name: Delete intermediate artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: nsis-temp-*

      - name: Upload combined bundle
        uses: actions/upload-artifact@v4
        with:
          name: nsis-bundle
          path: packages/nsis/out/**/*.tar.gz
          if-no-files-found: error
          retention-days: 30

  test-nsis:
    name: Test NSIS Bundle (${{ matrix.platform }})
    runs-on: ${{ matrix.runner }}
    needs: combine-artifacts
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: Windows
            runner: windows-latest
            binary: makensis.ps1
          - platform: Windows
            runner: windows-latest
            binary: makensis.cmd
          - platform: Linux
            runner: ubuntu-latest
            binary: makensis
          - platform: macOS-x64
            runner: macos-15-intel
            binary: makensis
          - platform: macOS-arm64
            runner: macos-15
            binary: makensis
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download combined bundle
        uses: actions/download-artifact@v4
        with:
          name: nsis-bundle
          path: packages/nsis/out

      - name: Find NSIS bundle
        shell: bash
        run: |
          BUNDLE_PATH="./packages/nsis/out/nsis"
          echo "Listing bundle folder:"
          ls -lhR "$BUNDLE_PATH"

          # Determine extraction target
          NSIS_BUNDLE="$BUNDLE_PATH/nsis-bundle"
          mkdir -p "$NSIS_BUNDLE"

          # Convert path for Windows runners
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            # GitHub Actions /d/... -> D:\...
            WIN_NSIS_BUNDLE=$(echo "$NSIS_BUNDLE" | sed -E 's#^/([a-zA-Z])/#\1:\\#; s#/#\\#g')
            echo "NSIS_BUNDLE=$WIN_NSIS_BUNDLE" >> $GITHUB_ENV
          else
            echo "NSIS_BUNDLE=$NSIS_BUNDLE" >> $GITHUB_ENV
          fi

          # Enable nullglob for pattern matching
          shopt -s nullglob || true

          # Find the archive
          archives=( "$BUNDLE_PATH"/*complete*.tar.gz )
          if (( ${#archives[@]} == 0 )); then
              echo "ERROR: no *complete*.tar.gz files found in $BUNDLE_PATH"
              exit 1
          fi

          echo "Using archive: ${archives[0]}"

          # Extract into NSIS_BUNDLE folder explicitly
          tar -xzf "${archives[0]}" -C "$BUNDLE_PATH"

          # Verify contents
          echo "Listing extracted files:"
          ls -lh "$NSIS_BUNDLE/nsis-bundle" || ls -lh "$NSIS_BUNDLE"

          # Final sanity check
          if [ ! -d "$NSIS_BUNDLE" ]; then
            echo "❌ NSIS bundle directory not found after extraction!"
            exit 1
          fi

          echo "✅ NSIS bundle ready at $NSIS_BUNDLE"

      - name: Create test NSIS script
        shell: bash
        run: |
          cat > test.nsi << 'EOF'
          !include "MUI2.nsh"

          Name "Test Installer"
          OutFile "test-installer.exe"
          InstallDir "$PROGRAMFILES\TestApp"

          !insertmacro MUI_PAGE_WELCOME
          !insertmacro MUI_PAGE_DIRECTORY
          !insertmacro MUI_PAGE_INSTFILES
          !insertmacro MUI_PAGE_FINISH

          !insertmacro MUI_LANGUAGE "English"

          Section "Main"
            SetOutPath "$INSTDIR"
            WriteUninstaller "$INSTDIR\Uninstall.exe"
          SectionEnd

          Section "Uninstall"
            Delete "$INSTDIR\Uninstall.exe"
            RMDir "$INSTDIR"
          SectionEnd
          EOF

      # Step: Test makensis binary (PowerShell on Windows)
      - name: Test makensis (PowerShell)
        if: runner.os == 'Windows' && endsWith(matrix.binary, '.ps1')
        shell: pwsh
        run: |
          $BINARY_PATH=${{ env.NSIS_BUNDLE }}\${{ matrix.binary }}
          echo "Running PowerShell binary: $BINARY_PATH"
          & "$BINARY_PATH" -VERSION
          & "$BINARY_PATH" test.nsi

      # Step: Test makensis binary (CMD on Windows)
      - name: Test makensis (CMD)
        if: runner.os == 'Windows' && endsWith(matrix.binary, '.cmd')
        shell: cmd
        run: |
          set BINARY_PATH=${{ env.NSIS_BUNDLE }}\${{ matrix.binary }}
          echo Running CMD binary: %BINARY_PATH%
          "%BINARY_PATH%" -VERSION
          "%BINARY_PATH%" test.nsi

      # Step: Test makensis binary (Linux/macOS)
      - name: Test makensis (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          BINARY_PATH="${{ env.NSIS_BUNDLE }}/${{ matrix.binary }}"
          chmod +x "$BINARY_PATH"
          "$BINARY_PATH" -VERSION
          "$BINARY_PATH" test.nsi

      - name: Verify output
        run: |
          ls -l
          if [[ -f test-installer.exe ]]; then
              echo "✅ Test compilation successful!"
          else
              echo "❌ Test compilation failed – no output file"
              exit 1
          fi

      - name: Check NSIS plugins
        run: |
          plugin_count="$(find share/nsis/Plugins -name "*.dll" 2>/dev/null | wc -l | tr -d ' ')"
          echo "Found $plugin_count plugin DLLs"
          if (( plugin_count < 20 )); then
              echo "⚠️  Warning: Expected more plugins"
          else
              echo "✅ Plugin count looks good"
          fi
