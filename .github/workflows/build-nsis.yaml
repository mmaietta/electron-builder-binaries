name: Build NSIS

on:
  workflow_call:
  workflow_dispatch:
    inputs:
      nsis_version:
        description: 'NSIS Version'
        required: false
        default: '3.10'
      nsis_branch:
        description: 'NSIS Branch/Tag'
        required: false
        default: 'v310'

env:
  NSIS_VERSION: ${{ github.event.inputs.nsis_version || '3.10' }}
  NSIS_BRANCH_OR_COMMIT: ${{ github.event.inputs.nsis_branch || 'v310' }}

jobs:
  # Build base bundle (Windows binary + plugins + data)
  base:
    name: Build Base Bundle
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl unzip p7zip-full
        shell: bash

      - name: Build base bundle
        run: bash ./assets/nsis-windows.sh
        shell: bash
        working-directory: ./packages/nsis

      - name: Upload base artifact
        uses: actions/upload-artifact@v4
        with:
          name: nsis-temp-base
          path: packages/nsis/out/**/*.tar.gz
          if-no-files-found: error
          retention-days: 1

  # Build native macOS binaries
  mac:
    name: Build macOS Binary (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-15-intel
            arch: x64
          - runner: macos-15
            arch: arm64
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install scons
        shell: bash

      - name: Build macOS binary
        run: bash ./assets/nsis-mac.sh
        shell: bash
        working-directory: ./packages/nsis

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: nsis-temp-macos-${{ matrix.arch }}
          path: packages/nsis/out/**/*.tar.gz
          if-no-files-found: error
          retention-days: 1

  # Build native Linux binary using Docker
  linux:
    name: Build Linux Binary
    runs-on: ubuntu-latest
    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Linux binary
        run: bash ./assets/nsis-linux.sh
        shell: bash
        working-directory: ./packages/nsis

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: nsis-temp-linux
          path: packages/nsis/out/**/*.tar.gz
          if-no-files-found: error
          retention-days: 1

  # Combine all artifacts into final bundle
  combine-artifacts:
    name: Combine All Bundles
    runs-on: macos-latest
    needs: [base, mac, linux]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all NSIS artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: nsis-temp-*
          path: packages/nsis/out
          merge-multiple: true

      - name: List downloaded artifacts
        run: |
          echo "Downloaded artifacts:"
          ls -lhR packages/nsis/out
        shell: bash

      - name: Combine bundles
        run: bash ./assets/nsis-combine.sh
        shell: bash
        working-directory: ./packages/nsis

      - name: Delete intermediate artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: nsis-temp-*

      - name: Upload combined bundle
        uses: actions/upload-artifact@v4
        with:
          name: nsis-bundle
          path: packages/nsis/out/**/*.tar.gz
          if-no-files-found: error
          retention-days: 30

  # Test the combined bundle on all platforms
  test-bundle:
    name: Test Bundle on ${{ matrix.platform }}
    runs-on: ${{ matrix.runner }}
    needs: combine-artifacts
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: Windows
            runner: windows-latest
            binary: windows/makensis.exe
          - platform: Linux
            runner: ubuntu-latest
            binary: linux/makensis
          - platform: macOS-x64
            runner: macos-15-intel
            binary: mac/x64/makensis
          - platform: macOS-arm64
            runner: macos-15
            binary: mac/arm64/makensis
    steps:
      - name: Download combined bundle
        uses: actions/download-artifact@v4
        with:
          name: nsis-bundle

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run tests
        shell: bash
        run: |
          bash ./assets/test-bundle.sh "${{ matrix.platform }}" makensis `pwd`/out/nsis
        working-directory: packages/nsis