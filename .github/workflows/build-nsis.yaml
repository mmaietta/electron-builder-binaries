name: Build NSIS

on:
  workflow_call:
  workflow_dispatch:

jobs:
  # Build base bundle (Windows binary + plugins + data)
  base:
    name: Build Base Bundle
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl unzip p7zip-full
        shell: bash

      - name: Build base bundle
        run: bash ./build.sh windows
        shell: bash
        working-directory: ./packages/nsis

      - name: Upload base artifact
        uses: actions/upload-artifact@v4
        with:
          name: nsis-temp-base
          path: packages/nsis/out/**/*.tar.gz
          if-no-files-found: error
          retention-days: 1

  # Build native macOS binaries
  mac:
    name: Build macOS Binary (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-15-intel
            arch: x64
          - runner: macos-15
            arch: arm64
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install scons
        shell: bash

      - name: Build macOS binary
        run: bash ./build.sh mac
        shell: bash
        working-directory: ./packages/nsis

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: nsis-temp-macos-${{ matrix.arch }}
          path: packages/nsis/out/**/*.tar.gz
          if-no-files-found: error
          retention-days: 1

  # Build native Linux binary using Docker
  linux:
    name: Build Linux Binary
    runs-on: ubuntu-latest
    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Linux binary
        run: bash ./build.sh linux
        shell: bash
        working-directory: ./packages/nsis

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: nsis-temp-linux
          path: packages/nsis/out/**/*.tar.gz
          if-no-files-found: error
          retention-days: 1

  # Combine all artifacts into final bundle
  combine-artifacts:
    name: Combine All Bundles
    runs-on: macos-latest
    needs: [base, mac, linux]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all NSIS artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: nsis-temp-*
          path: packages/nsis/out
          merge-multiple: true

      - name: List downloaded artifacts
        run: |
          echo "Downloaded artifacts:"
          ls -lhR packages/nsis/out
        shell: bash

      - name: Combine bundles
        run: bash ./assets/nsis-combine.sh
        shell: bash
        working-directory: ./packages/nsis

      - name: Delete intermediate artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: nsis-temp-*

      - name: Upload combined bundle
        uses: actions/upload-artifact@v4
        with:
          name: nsis-bundle
          path: packages/nsis/out/**/*.tar.gz
          if-no-files-found: error
          retention-days: 30

  # Test the combined bundle on all platforms
  test-bundle:
    name: Test Bundle (${{ matrix.platform }})
    runs-on: ${{ matrix.runner }}
    needs: combine-artifacts
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: Windows
            runner: windows-latest
            binary: makensis.ps1
          - platform: Linux
            runner: ubuntu-latest
            binary: makensis
          - platform: macOS-x64
            runner: macos-15-intel
            binary: makensis
          - platform: macOS-arm64
            runner: macos-15
            binary: makensis
    steps:

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download combined bundle
        uses: actions/download-artifact@v4
        with:
          name: nsis-bundle
          path: packages/nsis/out
          
      - name: List bundle contents
        shell: bash
        run: |
          ls -lhR packages/nsis/out

      - name: Run tests (linx/mac)
        shell: bash
        # if: runner.os != 'Windows'
        run: |
          bash ./assets/test-bundle.sh "${{ matrix.platform }}" "${{ matrix.binary }}" "`pwd`/out/nsis"
        working-directory: packages/nsis

      # - name: Run tests (Windows)
      #   if: runner.os == 'Windows'
      #   run: |
      #     .\assets\test-bundle.ps1 -Platform "${{ matrix.platform }}" -Binary "${{ matrix.binary }}" -BundlePath "$(pwd)\out\nsis"
      #   shell: powershell